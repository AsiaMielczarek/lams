<?xml version="1.0" encoding="UTF-8"?>

<project name="Unix-Updater-Helper" default="run-all" basedir=".">

	<property name="HOME" value="/home/asukkar/" />
	<property name="WORKSPACE" value="${HOME}/Workspaces/lams23installer/" />
	<property name="JBOSS" value="${HOME}/jboss-4.0.2/" />


	<target name="run-all">
		<ant antfile="${WORKSPACE}/lams_build/build.xml" target="lams-cruise" inheritall="false">
		</ant>

		<antcall target="setup-assembly-folder">
		</antcall>
		<antcall target="remove-new-tools-from-assembly">
		</antcall>
		<antcall target="build-new-tools">
		</antcall>
		<ant antfile="${basedir}/build.xml" target="copy-tools" />

		<!-- specific for the 2.3 pixlr tool -->
		<copy todir="${basedir}/tools/lapixl10/">
			<fileset dir="${WORKSPACE}/lams_tool_pixlr/web/images/">
				<include name="blank.jpg" />
			</fileset>
		</copy>

		<antcall target="copy-conf-files">
		</antcall>
		<antcall target="update-language-pack-libraries" />
		<ant antfile="${basedir}/build.xml" target="clean" />
		<ant antfile="${basedir}/build.xml" target="build" />
	</target>

	<target name="setup-assembly-folder">

		<!-- Remove files from assembly folder -->
		<delete includeemptydirs="true" verbose="true">
			<fileset dir="${basedir}/assembly/">
				<include name="lams.ear/*" />
				<include name="lams-session.jar" />
				<include name="lams-valve.jar" />
			</fileset>
		</delete>

		<!-- Copy lams-ear from JBOSS -->
		<copy todir="${basedir}/assembly">
			<fileset dir="${JBOSS}/server/default/deploy/">
				<include name="lams.ear/**" />
			</fileset>
		</copy>

		<!-- Copy lams-session.jar and lams-valve.jar -->
		<copy todir="${basedir}/assembly/" verbose="true">
			<fileset dir="${WORKSPACE}/lams_common/build/lib/">
				<include name="lams-valve.jar" />
				<include name="lams-session.jar" />
			</fileset>
		</copy>

		<!-- ensure secure folder is empty -->
		<delete includeemptydirs="true">
			<fileset dir="${basedir}/assembly/lams.ear/lams-www.war/secure" includes="**/*" />
		</delete>

		<!-- remove news.html -->
		<delete file="${basedir}/assembly/lams.ear/lams-www.war/news.html">
		</delete>

	</target>

	<target name="build-new-tools">
		<ant antfile="${WORKSPACE}/lams_tool_assessment/build.xml" target="create-deploy-package" dir="${WORKSPACE}/lams_tool_assessment/">
			<property name="generate.for.installers" value="true" />
		</ant>
		<ant antfile="${WORKSPACE}/lams_tool_images/build.xml" target="create-deploy-package" dir="${WORKSPACE}/lams_tool_images/">
			<property name="generate.for.installers" value="true" />
		</ant>
		<ant antfile="${WORKSPACE}/lams_tool_mindmap/build.xml" target="create-deploy-package" dir="${WORKSPACE}/lams_tool_mindmap/">
			<property name="generate.for.installers" value="true" />
		</ant>
		<ant antfile="${WORKSPACE}/lams_tool_pixlr/build.xml" target="create-deploy-package" dir="${WORKSPACE}/lams_tool_pixlr/">
			<property name="generate.for.installers" value="true" />
		</ant>
		<ant antfile="${WORKSPACE}/lams_tool_videorecorder/build.xml" target="create-deploy-package" dir="${WORKSPACE}/lams_tool_videorecorder/">
			<property name="generate.for.installers" value="true" />
		</ant>
	</target>

	<target name="copy-conf-files">
		<copy todir="${basedir}/conf/unix/jboss/" verbose="true">
			<fileset dir="${WORKSPACE}/lams_build/conf/unix/jboss/">
				<include name="*.slim.xml" />
			</fileset>
		</copy>
	</target>

	<target name="update-language-pack-libraries">
		<delete includeemptydirs="true" verbose="true">
			<fileset dir="${basedir}/language-pack/library/">
				<include name="**/*" />
			</fileset>
		</delete>

		<copy todir="${basedir}/language-pack/library/chatscribe" verbose="true">
			<fileset dir="${WORKSPACE}/lams_build/librarypackages/chatscribe/language/lams">
				<include name="*.properties" />
			</fileset>
		</copy>
		
		<copy todir="${basedir}/language-pack/library/forumscribe" verbose="true">
			<fileset dir="${WORKSPACE}/lams_build/librarypackages/forumscribe/language/lams">
				<include name="*.properties" />
			</fileset>
		</copy>
				
		<copy todir="${basedir}/language-pack/library/shareresourcesforum" verbose="true">
			<fileset dir="${WORKSPACE}/lams_build/librarypackages/shareresourcesforum/language/lams">
				<include name="*.properties" />
			</fileset>
		</copy>		
		
	</target>

	<target name="remove-new-tools-from-assembly">
		<delete>
			<fileset dir="${basedir}/assembly/lams.ear">
				<include name="lams-tool-laasse10.jar" />
				<include name="lams-tool-laasse10.war" />

				<include name="lams-tool-laimag10.jar" />
				<include name="lams-tool-laimag10.war" />

				<include name="lams-tool-lamind10.jar" />
				<include name="lams-tool-lamind10.war" />

				<include name="lams-tool-lapixl10.jar" />
				<include name="lams-tool-lapixl10.war" />

				<include name="lams-tool-lavidr10.jar" />
				<include name="lams-tool-lavidr10.war" />
			</fileset>
		</delete>
	</target>

</project>
