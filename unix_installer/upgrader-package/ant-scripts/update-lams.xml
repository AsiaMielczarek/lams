<?xml version="1.0" encoding="UTF-8"?>

<!--
#   Copyright (C) 2008 LAMS Foundation (http://lamsfoundation.org)
#   License Information: http://lamsfoundation.org/licensing/lams/2.0/
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License version 2.0 
#   as published by the Free Software Foundation.
# 
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
# 
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301
#   USA
# 
#   http://www.gnu.org/licenses/gpl.txt 
#
#   Author: Luke Foxton
-->

<project name="update-lams" basedir=".">
    <property file="../lams.properties" />
    <property file="lang.properties"/>
	
    <!-- Main Task, calls all the other tasks -->
    <target name="update-lams" description="Runs the entire update process">
    	
<!-- 
        <antcall target="copy-core-jars-wars" />
        <antcall target="update-lams-www-war" />
    	<antcall target="update-lams-central-war" />
        <antcall target="language-pack" />
-->
    	<antcall target="deploy-new-tools" />
        <antcall target="set-lams-configuration" />
    </target>

    <target name="copy-core-jars-wars" description="Overwrites lams.ear files built from assemble-ear ant task. Does not deploy tools">
        <echo message="Overwriting assembled files into the deploy directory"/>
        <copy todir="${DEPLOY_DIR}/lams.ear" overwrite="true">
            <fileset dir="../assembly/lams.ear" >
                <exclude name="*.bak"/>
                <exclude name="*.tmp"/>
            </fileset>
        </copy>
        <echo message="lams.ear successfully updated"/>
    </target>

    <target name="update-lams-www-war" description="Updates files in lams-www.war">
        <echo>Updating lams-www.war</echo>


        <copy todir="${DEPLOY_DIR}/lams.ear/lams-www.war/images" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-www.war/images/">
                <include name="learner.logo.swf"/>
                <include name="monitor.logo.swf"/>
                <include name="preloader.logo.swf"/>
                <include name="about.logo.swf"/>
            </fileset>          
        </copy>
    
        <copy todir="${DEPLOY_DIR}/lams.ear/lams-www.war/WEB-INF/tags" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-www.war/WEB-INF/tags">
				<include name="*.tag"/>
   			</fileset>
       	</copy>
        
        <copy todir="${DEPLOY_DIR}/lams.ear/lams-www.war/WEB-INF" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-www.war/WEB-INF">
                <include name="lams.tld"/>
            </fileset>
        </copy> 
    	
    	<copy todir="${DEPLOY_DIR}/lams.ear/lams-www.war/" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-www.war/">
                <include name="htmltemplates.xml"/>
            	<include name="copyright.jsp"/>
            </fileset>
        </copy> 
    	
    	<copy todir="${DEPLOY_DIR}/lams.ear/lams-www.war/images" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-www.war/images">
                <include name="template*.gif"/>
            </fileset>
        </copy>

    </target>
	
	<target name="update-lams-central-war" description="Updates files in lams-central.war">
        <echo>Updating lams-central.war</echo>
		<copy todir="${DEPLOY_DIR}/lams.ear/lams-central.war" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-central.war">
                <exclude name="META-INF/MANIFEST.MF"/>
            	<exclude name="WEB-INF/web.xml"/>
            </fileset>          
        </copy>
    </target>
	
	<target name="language-pack" description="Runs the latest language pack included with the updater">
		<echo>Applying language pack</echo>
		
		<!-- Overwrite language files, but leave the combined task language files alone -->
		<copy todir="${DEPLOY_DIR}/lams.ear/lams-dictionary.jar" overwrite="true">
            <fileset dir="../assembly/lams.ear/lams-dictionary.jar">
                <exclude name="**/library/**"/>
            </fileset>          
        </copy>
		
		<!-- Overwrite flash language files-->
		<copy todir="${DEPLOY_DIR}/lams.ear/lams-central.war/flashxml" overwrite="true">
	            <fileset dir="../assembly/lams.ear/lams-central.war/flashxml/"/>
	   	</copy>
    	
		<!-- Copy combined activity language files to appropriate directory -->
    	<java classname="copyllid" failonerror="true" fork="true">
        	<arg value="${JBOSS_DIR}"/>
        	<arg value="${DB_USER}"/>
        	<arg value="${DB_PASS}"/>
        	<arg value="${DB_NAME}"/>
        	<arg value="${SQL_URL}"/>
        	<classpath>
                <pathelement path="../bin:../tools/lib/mysql-connector-java-5.0.8-bin.jar"/>
            </classpath>
        </java>
		
        <sql driver="com.mysql.jdbc.Driver" 
            classpath="../tools/lib/mysql-connector-java-5.0.8-bin.jar" 
            url="${SQL_URL}" 
            userid="${DB_USER}" 
            password="${DB_PASS}"
            encoding="utf8"
            onerror="abort" keepformat="true"
            >
            <transaction src="../sql-scripts/updateLocales.sql" />
        </sql>

    </target>


    <target name="explode-wars" description="Explodes the lams-learning and lams-monitoring wars so their files can be altered by the tool deployer">
        <ant antfile="update-deploy-tools.xml" output="../log/explode-wars.log" target="explode-wars">
            <property name="jboss.deploy" value="${EAR_DIR}"/>
        </ant>
    </target>

    <target name="compress-wars" description="Compresses the lams-learning and lams-monitoring wars after their files have been altered by the tool deployer">
        <ant antfile="update-deploy-tools.xml" output="../log/compress-wars.log" target="compress-wars">
            <property name="jboss.deploy" value="${EAR_DIR}"/>
        </ant>
    </target>
    	
    <target name="deploy-new-tools" description="Deploys any new tools added for this updater, must be updated for each release">
    	<!--<antcall target="explode-wars"/>-->
    	
    	<echo>Deploying new tools</echo>
    	
    	<!-- ============= 2.3.5 Tools ============== -->
    	<antcall target="deploy-new-tool">
    	   	<param name="signature" value="eueadv10"/>
    	</antcall>
    	
    	<!--<antcall target="compress-wars"/>-->
    </target>
    	
	<target name="deploy-new-tool" description="Fully deploys a tool">
    	<antcall target="filter-deploy-xml">
    	    <param name="signature" value="${signature}"/>
    	</antcall>
    	<ant antfile="update-deploy-tools.xml" output="../log/deploy-${signature}.log" target="deploy-tool">
            <property name="prop.path" value="${signature}"/>
        </ant>
	</target>
    	
    <target name="filter-deploy-xml" description="Filters a new tool's deploy.xml and fills in the appropriate values for this install">
    	<ant antfile="update-deploy-tools.xml" output="../log/create-${signature}-deploy.log" target="create-deploy-package">
            <property name="prop.path" value="${signature}"/>
        </ant>
   	</target>

    <target name="set-lams-configuration" description="Updates the lams_configuration table with all the settings from lams.properties">
        <sql driver="com.mysql.jdbc.Driver" 
            classpath="${DEPLOY_DIR}/lams.ear/mysql-connector-java-5.0.8-bin.jar" 
            url="${SQL_URL}" 
            userid="${DB_USER}" 
            password="${DB_PASS}"
            encoding="utf8"
            onerror="abort" keepformat="true"
            >
            <transaction src="../sql-scripts/setLamsConfiguration.sql" />
        </sql>
    </target>
</project>
