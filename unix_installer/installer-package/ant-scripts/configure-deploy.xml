<?xml version="1.0" encoding="UTF-8"?>

<project name="configure-deploy" basedir="..">
	<property file="lams.properties" />
	
	<target name="configure-wrapper" description="Configuring the JAVA service Wrapper">
		<echo message="Copying the configuration files required for the wrapper"/>
		
		<copy overwrite="true" todir="${JBOSS_DIR}/conf/" failonerror="true">
                        <fileset dir="wrapper">
                                <include name="wrapper.conf" />
                        </fileset>
                	<filterset>
                        	<filter token="JAVA_HOME" value="${JDK_DIR}"/>
               		</filterset>
		</copy>
	
	</target>

	<target name="copy-conf" description="Copying the configuration files required for LAMS">
		<echo message="Copying the configuration files required for LAMS"/>
		<copy overwrite="true" todir="${DEFAULT_DIR}/conf/" failonerror="true">
			<fileset dir="${JBOSS_CONF}/">
				<include name="login-config.xml" />
				<include name="log4j.xml" />
				<include name="jboss-service.xml" />
			</fileset>
		<filterset>
			<filter token="confdir" value="${DEFAULT_DIR}/conf"/>
		</filterset>
		</copy>


		<copy overwrite="true" todir="${DEPLOY_DIR}" failonerror="true">
			<fileset dir="${JBOSS_CONF}/service">
				<include name="mysql*.xml" />
			</fileset>
			<filterset>
				<filter token="DB_NAME" value="${DB_NAME}" />
				<filter token="DB_USER" value="${DB_USER}" />
				<filter token="DB_PASS" value="${DB_PASS}" />
				<filter token="MYSQL_HOST" value="${SQL_HOST}" />
				<filter token="MYSQL_PORT" value="${SQL_PORT}" />
			</filterset>
		</copy>
		<copy overwrite="true" todir="${DEPLOY_DIR}" failonerror="true">
			<fileset dir="${JBOSS_CONF}/service">
				<include name="local-service.xml" />
			</fileset>
		</copy>

		<copy overwrite="true" todir="${DEPLOY_DIR}/jbossweb-tomcat55.sar/META-INF" failonerror="true">
			<fileset dir="${JBOSS_CONF}/tomcat">
				<include name="jboss-service.xml" />
			</fileset>
		</copy>

		<copy overwrite="true" todir="${DEPLOY_DIR}/jbossweb-tomcat55.sar/" failonerror="true">
			<fileset dir="${JBOSS_CONF}/tomcat">
				<include name="server.xml" />
			</fileset>
			<filterset>
				<filter token="LAMS_PORT" value="${LAMS_PORT}"/>
			</filterset>
		</copy>

		<copy overwrite="true" todir="${DEPLOY_DIR}/jbossweb-tomcat55.sar/" failonerror="true">
			<fileset dir="${JBOSS_CONF}/tomcat">
				<include name="context.xml" />
			</fileset>
		</copy>

		<copy overwrite="true" todir="${DEPLOY_DIR}/jbossweb-tomcat55.sar/conf" failonerror="true">
			 <fileset dir="${JBOSS_CONF}/tomcat">
				 <include name="web.xml" />
			 </fileset>
		</copy>
		
		<copy overwrite="true" todir="${BINDIR}">
                        <fileset dir="bin">
                                <include name="run-lams.sh" />
                        </fileset>
                        <filterset>
                                <filter token="JAVA_HOME" value="${JDK_DIR}" />
                        </filterset>
                </copy>

	 </target>
	
	<target name="slim-jboss" description="makes a backup and removes unnecessary services from JBoss 4.0.2;
		do not run it twice, otherwise you will need to copy standardjboss.xml and ejb-deployer.xml
		from the original JBoss distribution and then build the whole LAMS project">
		<!-- Backup -->
		<copy todir="${DEFAULT_DIR}/slim-backup/deploy">
			<fileset dir="${DEPLOY_DIR}/">
				<include name="ejb-deployer.xml"/>
				<include name="client-deployer-service.xml"/>
				<include name="schedule-manager-service.xml"/>
				<include name="scheduler-service.xml"/>
				<include name="bsh-deployer.xml"/>
				<include name="jboss-aop.deployer/"/>
				<include name="jboss-ws4ee.sar/"/>
				<include name="jmx-console.war/"/>
				<include name="http-invoker.sar/"/>
			</fileset>
		</copy>
		
		<copy todir="${DEFAULT_DIR}/slim-backup/conf">
			<fileset dir="${DEFAULT_DIR}/conf">
				<include name="jboss-service.xml"/>
				<include name="standardjboss.xml"/>
			</fileset>
		</copy>
		
		<copy todir="${DEFAULT_DIR}/slim-backup/lib">
			<fileset dir="${DEFAULT_DIR}/lib">
				<include name="autonumber-plugin.jar"/>
				<include name="bcel.jar"/>
				<include name="jboss-jaxrpc.jar"/>
				<include name="jboss-saaj.jar"/>
				<include name="scheduler-plugin.jar"/>
				<include name="scheduler-plugin-example.jar"/>
				<include name="bsh-1.3.0.jar"/>
				<include name="bsh-deployer.jar"/>
			</fileset>
		</copy>
		
		<!-- Configuring -->
		<copy overwrite="yes" file="${JBOSS_CONF}/ejb-deployer.slim.xml" tofile="${DEPLOY_DIR}/ejb-deployer.xml" />
		<copy overwrite="yes" file="${JBOSS_CONF}/jboss-service.slim.xml" tofile="${DEFAULT_DIR}/conf/jboss-service.xml" />
		<copy overwrite="yes" file="${JBOSS_CONF}/standardjboss.slim.xml" tofile="${DEFAULT_DIR}/conf/standardjboss.xml" />
		
		
		<delete dir="${DEPLOY_DIR}jboss-aop.deployer" />
		<delete dir="${DEPLOY_DIR}/jboss-ws4ee.sar" />
		<delete dir="${DEPLOY_DIR}/jmx-console.war"/>
		<delete dir="${DEPLOY_DIR}/http-invoker.sar"/>
		
		<delete file="${DEPLOY_DIR}/client-deployer-service.xml"/>
		<delete file="${DEPLOY_DIR}/schedule-manager-service.xml"/>
		<delete file="${DEPLOY_DIR}/scheduler-service.xml"/>
		<delete file="${DEPLOY_DIR}/bsh-deployer.xml"/>
		
		<delete file="${DEFAULT_DIR}/lib/autonumber-plugin.jar"/>
		<delete file="${DEFAULT_DIR}/lib/bcel.jar"/>
		<delete file="${DEFAULT_DIR}/lib/jboss-jaxrpc.jar"/>
		<delete file="${DEFAULT_DIR}/lib/jboss-saaj.jar"/>
		<delete file="${DEFAULT_DIR}/lib/scheduler-plugin.jar"/>
		<delete file="${DEFAULT_DIR}/lib/scheduler-plugin-example.jar"/>
		<delete file="${DEFAULT_DIR}/lib/bsh-1.3.0.jar"/>
		<delete file="${DEFAULT_DIR}/lib/bsh-deployer.jar"/>
	</target>
	
	<target name="slim-jboss-revert" description="reverts changes made by slim-jboss task">
		<copy overwrite="yes" todir="${DEPLOY_DIR}">
			<fileset dir="${DEFAULT_DIR}/slim-backup/deploy/">
				<include name="*/"/>
			</fileset>
		</copy>
		
		<copy overwrite="yes" todir="${DEFAULT_DIR}/conf">
			<fileset dir="${DEFAULT_DIR}/slim-backup/conf">
				<include name="*.xml"/>
			</fileset>
		</copy>
		
		<copy overwrite="yes" todir="${DEFAULT_DIR}/lib">
			<fileset dir="${DEFAULT_DIR}/slim-backup/lib">
				<include name="*"/>
			</fileset>
		</copy>
	</target>
	
	<target name="deploy-pixlr-images" description="Adds pixlr images to lams-www.war/images/pixlr">
		<!-- Add pixlr images to lams-www.war/images/pixlr -->
		<mkdir dir="${EAR_DIR}/lams-www.war/images/pixlr"/>
		<copy todir="${EAR_DIR}/lams-www.war/images/pixlr" verbose="true">
			<fileset dir="${basedir}/images/pixlr/">
				<include name="**/*"/>
			</fileset>	
		</copy>
	</target>

</project>


