<?xml version="1.0" encoding="UTF-8"?>

<project name="Unix-Installer-Helper" default="run-all" basedir=".">

	<property name="HOME" value="/home/asukkar/" />
	<property name="WORKSPACE" value="${HOME}/Workspaces/lams23installer/" />
	<property name="JBOSS" value="${HOME}/jboss-4.0.2/" />


	<target name="run-all">
		<antcall target="setup-jboss">
		</antcall>
		<ant antfile="${WORKSPACE}/lams_build/build.xml" target="lams-cruise" inheritall="false">
		</ant>
		<antcall target="deploy-new-tools">
		</antcall>
		<antcall target="setup-assembly-folder">
		</antcall>
		<antcall target="copy-conf-files">
		</antcall>
		<antcall target="update-log4j">
		</antcall>
		<antcall target="update-myqslds">
		</antcall>
		<ant antfile="${basedir}/build.xml" target="clean" />
		<ant antfile="${basedir}/build.xml" target="build" />
	</target>

	<target name="setup-jboss">
		<delete dir="${JBOSS}">
		</delete>
		<delete file="${HOME}/jboss-4.0.2.tar">
		</delete>

		<gunzip src="${HOME}/jboss-4.0.2.tar.gz" />
		<untar src="${HOME}/jboss-4.0.2.tar" dest="${HOME}">
		</untar>
	</target>

	<target name="setup-assembly-folder">

		<!-- Remove files from assembly folder -->
		<delete includeemptydirs="true" verbose="true">
			<fileset dir="${basedir}/assembly/">
				<include name="lams.ear/*" />
				<include name="lams-session.jar" />
				<include name="lams-valve.jar" />
				<include name="jboss-cache.jar" />
				<include name="jgroups.jar" />
				<include name="jboss-serialization.jar" />
			</fileset>
		</delete>

		<!-- Copy lams-ear from JBOSS -->
		<copy todir="${basedir}/assembly">
			<fileset dir="${JBOSS}/server/default/deploy/">
				<include name="lams.ear/**" />
			</fileset>
		</copy>

		<!-- Copy lams-session.jar and lams-valve.jar -->
		<copy todir="${basedir}/assembly/" verbose="true">
			<fileset dir="${WORKSPACE}/lams_common/build/lib/">
				<include name="lams-session.jar" />
				<include name="lams-valve.jar" />
			</fileset>
		</copy>

		<!-- Copy jboss-cache.jar jgroups.jar jboss-serialization.jar -->
		<copy todir="${basedir}/assembly/" verbose="true">
			<fileset dir="${WORKSPACE}/lams_build/lib/jboss">
				<include name="jboss-cache.jar" />
				<include name="jgroups.jar" />
				<include name="jboss-serialization.jar" />
			</fileset>
		</copy>

	</target>

	<target name="deploy-new-tools">
		<ant antfile="${WORKSPACE}/lams_tool_assessment/build.xml" dir="${WORKSPACE}/lams_tool_assessment/" target="deploy-tool" />
		<ant antfile="${WORKSPACE}/lams_tool_images/build.xml" dir="${WORKSPACE}/lams_tool_images/" target="deploy-tool" />
		<ant antfile="${WORKSPACE}/lams_tool_mindmap/build.xml" dir="${WORKSPACE}/lams_tool_mindmap/" target="deploy-tool" />
		<ant antfile="${WORKSPACE}/lams_tool_pixlr/build.xml" dir="${WORKSPACE}/lams_tool_pixlr/" target="deploy-tool" />
		<ant antfile="${WORKSPACE}/lams_tool_videorecorder/build.xml" dir="${WORKSPACE}/lams_tool_videorecorder/" target="deploy-tool" />
	</target>

	<target name="copy-conf-files">
		<copy file="${WORKSPACE}/lams_build/conf/j2ee/lams.application.xml" tofile="${basedir}/conf/j2ee/application.xml" overwrite="true" />

		<copy todir="${basedir}/conf/unix/jboss" overwrite="true">
			<fileset dir="${WORKSPACE}/lams_build/conf/unix/jboss">
				<exclude name="**/CVS/*" />
				<exclude name="**/CVS/" />
			</fileset>
		</copy>
	</target>

	<target name="update-log4j">
		<replace file="${basedir}/conf/unix/jboss/log4j.xml" token="@application@" value="lams" />
	</target>

	<target name="update-myqslds">
		<replace file="${basedir}/conf/unix/jboss/service/mysql-ds.xml" token="localhost" value="@MYSQL_HOST@" />
		<replace file="${basedir}/conf/unix/jboss/service/mysql-ds.xml" token="3306" value="@MYSQL_PORT@" />
		<replace file="${basedir}/conf/unix/jboss/service/mysql-ds.xml" token="@db.name@" value="@DB_NAME@" />
		<replace file="${basedir}/conf/unix/jboss/service/mysql-ds.xml" token="@db.username@" value="@DB_USER@" />
		<replace file="${basedir}/conf/unix/jboss/service/mysql-ds.xml" token="@db.password@" value="@DB_PASS@" />
	</target>

</project>
