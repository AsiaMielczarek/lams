<?xml version="1.0" encoding="UTF-8"?>
<project name="update-deploy-tools" >
	<!-- begin properties *******************************************************************************************-->
	<!-- import properties from the specified file -->
	
	<property file="${prop.path}/build.properties" />
	<property file="tools.properties"/>

	<!-- =================================================================== -->
	<!-- Generate the deploy package                                         -->
	<!-- =================================================================== -->
	<target name="create-deploy-package" description="Generate the deployment package.">
		<echo>+------------------------------------------+</echo>
		<echo>| Generate the deployment package.         |</echo>
		<echo>+------------------------------------------+</echo>
		<echo>Generating deploy.xml for ${signature}</echo>
	
		<path id="deploy.lib.classpath">
			<fileset dir="${deploy.tool.dir}">
				<include name="lib/*.jar"/>
			</fileset>
		</path> 

		<taskdef name="generateDeployProperties" 
			classname="org.lamsfoundation.lams.tool.deploy.CreateToolPackageTask">
		    <classpath refid="deploy.lib.classpath"/>
		</taskdef>

		<generateDeployProperties 
			mode="production" 
			outputPath="${build.deploy}"
			dbPassword="${db.password}"
			dbUsername="${db.username}"
			dbDriverUrl="${db.url}"
			dbDriverClass="com.mysql.jdbc.Driver"
			deployFiles="${build.deploy}/${product}.war,${build.deploy}/${product}.jar"
			toolJarFileName="${product}.jar"
			toolSignature="${signature}"
			toolVersion="${tool.version}"
			hideTool="${hideTool}"
			minServerVersionNumber="${min.server.version.number}"
			toolUpdateScriptPath="${build.deploy}/sql/updatescripts/updateTo${tool.version}.sql"
			toolTablesScriptPath="${build.deploy}/sql/create_lams_tool_forum.sql" 
			toolTablesDeleteScriptPath="${build.deploy}/sql/drop_lams_tool_forum.sql" 
			toolActivityInsertScriptPath="${build.deploy}/sql/activity_insert.sql" 
			toolLibraryInsertScriptPath="${build.deploy}/sql/library_insert.sql" 
			toolInsertScriptPath="${build.deploy}/sql/tool_insert.sql" 
			toolApplicationContextPath="/org/lamsfoundation/lams/tool/forum/forumApplicationContext.xml"
			lamsEarPath="${jboss.deploy}"
			toolContext="${toolContext}"
			toolWebUri="${product}.war"
			languageFilesPackage="${language.files.package}">

			<!-- language files go as a fileset. Not nice but can't work out how to embed them in a tag. -->
			<fileset dir="${build.deploy}/language">
				<include name="**/*.properties"/>
				<include name="**/*.txt"/>
			</fileset>
				
		</generateDeployProperties>
		
		<echo>Deploy packaqe for ${signature} created.</echo>
			
		
		
	</target>
	
	<target name="update-custom-tool-contexts" description="Updates the web.xmls for the non-custom tools">
        <echo>Updating web.xml and MANIFEST.MF for lams-central.war, lams-monitor.war and lams-learning.war. using for custom tools</echo>
        <path id="deploy.lib.classpath">
            <fileset dir="${deploy.tool.dir}">
                <include name="lib/*.jar"/>
            </fileset>
        </path> 
        
        <java classname="org.lamsfoundation.lams.tool.deploy.AddCustomWebXmlContexts" classpathref="deploy.lib.classpath" fork="true">
            <arg value="${jboss.deploy}" />
            <arg value="${db.username}" />
            <arg value="${db.password}" />
            <arg value="${db.url}" />
        </java> 
    </target>
	    
	
	<target name="update-application-xml" description="Adds java modules to application.xml">
		<path id="deploy.lib.classpath">
			<fileset dir="${deploy.tool.dir}">
				<include name="lib/*.jar"/>
			</fileset>
		</path>
		
		<echo>Updating application.xml ###2.1 SPECIFIC###</echo>
		
		<java classname="org.lamsfoundation.lams.tool.deploy.AddModuleToApplicationXmlTask" classpathref="deploy.lib.classpath" fork="true">
			<arg value="${jboss.deploy}" />
			<arg value="commons-io-1.4.jar" />
		</java>
		
	</target>
	
	<target name="explode-wars" description="explodes lams_learning.war and lams-monitoring.war">
		<move file="${jboss.deploy}/lams-learning.war" tofile= "${jboss.deploy}/lams-learning.war.bak" />
		<move file="${jboss.deploy}/lams-monitoring.war" tofile= "${jboss.deploy}/lams-monitoring.war.bak" />
		<unwar src="${jboss.deploy}/lams-learning.war.bak" dest="${jboss.deploy}/lams-learning.war" />
		<unwar src="${jboss.deploy}/lams-monitoring.war.bak" dest="${jboss.deploy}/lams-monitoring.war" />
				
	</target>
		
	<target name="compress-wars" description="compresses lams_learning.war and lams-monitoring.war">
			
		<move file="${jboss.deploy}/lams-learning.war" tofile= "${jboss.deploy}/lams-learning.war.tmp" failonerror="false"/>
		<move file="${jboss.deploy}/lams-monitoring.war" tofile= "${jboss.deploy}/lams-monitoring.war.tmp" failonerror="false"/>
		
		<war warfile="${jboss.deploy}/lams-monitoring.war" manifest="${jboss.deploy}/lams-monitoring.war.tmp/META-INF/MANIFEST.MF" 
		  				webxml="${jboss.deploy}/lams-monitoring.war.tmp/WEB-INF/web.xml">
			
			<webinf dir="${jboss.deploy}/lams-monitoring.war.tmp/WEB-INF">
				<include name="**/*.xml"/>
				<include name="**/*.tld"/>
				<include name="struts/*"/>
				<include name="jstl/*"/>
				<include name="tags/*"/>
				<exclude name="web.xml"/>
			</webinf>
			<fileset dir="${jboss.deploy}/lams-monitoring.war.tmp">
				<include name="*"/>
				<include name="css/*"/>
				<include name="branching/*"/>
				<include name="gate/*"/>
				<include name="grouping/*"/>
				<include name="images/*"/>
				<include name="template/*"/>
			</fileset>
		</war>
		
		<war warfile="${jboss.deploy}/lams-learning.war" manifest="${jboss.deploy}/lams-learning.war.tmp/META-INF/MANIFEST.MF" 
				  				webxml="${jboss.deploy}/lams-learning.war.tmp/WEB-INF/web.xml">
					
			<webinf dir="${jboss.deploy}/lams-learning.war.tmp/WEB-INF">
				<include name="*.xml"/>
				<include name="struts/*"/>
				<include name="struts/tlds/*"/>
				<include name="jstl/*"/>
				<include name="jstl/tlds/*"/>
				<include name="tags/*"/>
				<include name="lams.tld"/>
				<exclude name="web.xml"/>
			</webinf>
			<fileset dir="${jboss.deploy}/lams-learning.war.tmp">
				<include name="*"/>
				<include name="css/*"/>
				<include name="branching/*"/>
				<include name="exportPortfolio/*"/>
				<include name="notebook/*"/>
				<include name="gate/*"/>
				<include name="grouping/*"/>
				<include name="images/*"/>
				<include name="layout/*"/>
				<include name="test/*"/>
			</fileset>
		</war>
		
		<delete dir="${jboss.deploy}/lams-learning.war.tmp" failonerror="false" />
		<delete dir="${jboss.deploy}/lams-monitoring.war.tmp" failonerror="false" />
	</target>
			
	<target name="deploy-tool" description="runs the tool deployer for a given tool">
		<path id="deploy.lib.classpath">
			<fileset dir="${deploy.tool.dir}">
				<include name="lib/*.jar"/>
			</fileset>
		</path> 
		
		<echo>Deploying the ${signature} Tool</echo>

		<java classname="org.lamsfoundation.lams.tool.deploy.Deploy" classpathref="deploy.lib.classpath" fork="true">
			<arg file="${build.deploy}/deploy.xml" />
			<arg value="False" />
		</java>
	</target>
	
	<target name="update-tool-context">
			<echo>Updating web.xml and MANIFEST.MF for lams-central.war, lams-monitor.war and lams-learning.war. using config from ${build.deploy}/deploy.xml</echo>
			
			<path id="deploy.lib.classpath">
				<fileset dir="${deploy.tool.dir}">
					<include name="lib/*.jar"/>
				</fileset>
			</path> 
			
			<java classname="org.lamsfoundation.lams.tool.deploy.UpdateToolContextPath" classpathref="deploy.lib.classpath" fork="true">
					<arg file="${build.deploy}/deploy.xml" />
			</java>	
	</target>
	
</project>