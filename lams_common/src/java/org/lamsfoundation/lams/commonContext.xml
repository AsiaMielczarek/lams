<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
  - Application context definition for LAMS. Used to deploy to JBOSS.
-->
<beans>

	<!-- ========================= GENERAL DEFINITIONS ========================= -->

	<!-- Message source for this context, loaded from localized "messages_xx" files -->
	<bean id="commonMessageService" class="org.lamsfoundation.lams.util.MessageService" >
		<property name="messageSource">
			<bean id="messageSource" class="org.springframework.context.support.ResourceBundleMessageSource">
				<property name="basename">
					<value>org.lamsfoundation.lams.ApplicationResources</value>
				</property>										
			</bean>
		</property>
    </bean>

	<!-- ========================= RESOURCE DEFINITIONS ========================= -->
  
 	<!-- Hibernate SessionFactory -->
	<bean id="coreSessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
		<property name="dataSource"><ref bean="dataSource"/></property>
		<property name="mappingResources">
			<list>
				<!-- usermanagement related mapping files -->	
				<value>org/lamsfoundation/lams/usermanagement/AuthenticationMethod.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/AuthenticationMethodType.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/Organisation.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/OrganisationState.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/OrganisationType.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/Role.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/Privilege.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/RolePrivilege.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/User.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/UserOrganisation.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/UserOrganisationRole.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/Workspace.hbm.xml</value>
				<value>org/lamsfoundation/lams/usermanagement/WorkspaceFolder.hbm.xml</value>
				
				<!-- learning design related mapping files -->
				<value>org/lamsfoundation/lams/learningdesign/Activity.hbm.xml</value>
				<value>org/lamsfoundation/lams/learningdesign/Group.hbm.xml</value>				
				<value>org/lamsfoundation/lams/learningdesign/Grouping.hbm.xml</value>
				<value>org/lamsfoundation/lams/learningdesign/LearningDesign.hbm.xml</value>
				<value>org/lamsfoundation/lams/learningdesign/LearningLibrary.hbm.xml</value>	
				<value>org/lamsfoundation/lams/learningdesign/Transition.hbm.xml</value>	
				<value>org/lamsfoundation/lams/learningdesign/License.hbm.xml</value>	
				
				
				<!-- lesson related mapping files-->
				<value>org/lamsfoundation/lams/lesson/LearnerProgress.hbm.xml</value>
				<value>org/lamsfoundation/lams/lesson/Lesson.hbm.xml</value>
 				
				<!-- Tool related mapping files-->
				<value>org/lamsfoundation/lams/tool/SystemTool.hbm.xml</value>
				<value>org/lamsfoundation/lams/tool/Tool.hbm.xml</value>
				<value>org/lamsfoundation/lams/tool/ToolContent.hbm.xml</value>
				<value>org/lamsfoundation/lams/tool/ToolSession.hbm.xml</value>
				
				<!-- Workspace related mapping files -->
				<value>org/lamsfoundation/lams/workspace/WorkspaceFolderContent.hbm.xml</value>
				
				<!-- Theme related mapping files -->
				<value>org/lamsfoundation/lams/themes/CSSProperty.hbm.xml</value>
				<value>org/lamsfoundation/lams/themes/CSSStyle.hbm.xml</value>
				<value>org/lamsfoundation/lams/themes/CSSThemeVisualElement.hbm.xml</value>
			</list>
		</property>
		<property name="hibernateProperties"><ref bean="hibernateProperties"/></property>
	</bean>
	
	<!-- ========================= BUSINESS OBJECT DEFINITIONS ========================= -->

	<!-- LAMS primary business object: Hibernate implementation -->
	<bean id="userManagementServiceTarget" class="org.lamsfoundation.lams.usermanagement.service.UserManagementService"
		singleton="false"
	>
		<property name="userDAO"><ref local="userDAO"/></property>
		<property name="roleDAO"><ref local="roleDAO"/></property>
		<property name="organisationDAO"><ref local="organisationDAO"/></property>
		<property name="organisationTypeDAO"><ref local="organisationTypeDAO"/></property>
		<property name="userOrganisationDAO"><ref local="userOrganisationDAO"/></property>
		<property name="userOrganisationRoleDAO"><ref local="userOrganisationRoleDAO"/></property>
		<property name="authenticationMethodDAO"><ref local="authenticationMethodDAO"/></property>
		<property name="workspaceFolderDAO"><ref bean="workspaceFolderDAO"/></property>
		<property name="userManagementWorkspaceDAO"><ref bean="userManagementWorkspaceDAO"/></property>
		<property name="learningDesignDAO"><ref bean="learningDesignDAO"/></property>
		<property name="lessonDAO"><ref bean="lessonDAO"/></property>
		<property name="cacheManager"><ref local="cacheManager"/></property>
	</bean>	
	
	<!-- Transactional proxy for the user management primary business object -->
	<bean id="userManagementService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name="transactionManager"><ref bean="transactionManager"/></property>
		<property name="target"><ref local="userManagementServiceTarget"/></property>
		<property name="proxyTargetClass"><value>true</value></property> 
		<property name="transactionAttributes">
			<props>
				<prop key="get*">PROPAGATION_REQUIRED</prop>
				<prop key="save*">PROPAGATION_REQUIRED</prop>
				<prop key="create*">PROPAGATION_REQUIRED</prop>
				<prop key="update*">PROPAGATION_REQUIRED</prop>
				<prop key="remove*">PROPAGATION_REQUIRED</prop>
				<prop key="delete*">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
	</bean>
	
	<bean id="learningDesignServiceTarget" class="org.lamsfoundation.lams.learningdesign.service.LearningDesignService">
		<property name="messageService"><ref bean="commonMessageService"/></property>
		<property name="learningDesignDAO"><ref bean="learningDesignDAO"/></property>
		<property name="activityDAO"><ref bean="activityDAO"/></property>
	</bean>
	
	<bean id="learningDesignService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name="transactionManager"><ref bean="transactionManager"/></property>
		<property name="target"><ref local="learningDesignServiceTarget"/></property>
		<property name="proxyTargetClass"><value>true</value></property> 
		<property name="transactionAttributes">
			<props>
				<prop key="validateLearningDesign">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
	</bean>
	
	<bean id="themeServiceTarget" class="org.lamsfoundation.lams.themes.service.ThemeService">
		<property name="themeDAO"><ref local="themeDAO"/></property>
		<property name="userManagementService"><ref local="userManagementService"/></property>
		<property name="messageService"><ref bean="commonMessageService"/></property>
	</bean>
	
	<bean id="themeService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name ="transactionManager"><ref bean ="transactionManager"/></property>
		<property name ="target"><ref bean="themeServiceTarget"/></property>
		<property name="proxyTargetClass"><value>true</value></property> 
		<property name="transactionAttributes">
			<props>
				<prop key="get*">PROPAGATION_REQUIRED</prop>
				<prop key="store*">PROPAGATION_REQUIRED</prop>
				<prop key="set*">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
	</bean>
	
	<bean id="exportToolContentServiceTarget" class="org.lamsfoundation.lams.learningdesign.service.ExportToolContentService">
		<property name="activityDAO"><ref bean="activityDAO"/></property>
		<property name="toolDAO"><ref bean="toolDAO"/></property>
		<property name="workspaceFolderDAO"><ref bean="workspaceFolderDAO"/></property>
		<property name="licenseDAO"><ref bean="licenseDAO"/></property>
		<property name="groupingDAO"><ref bean="groupingDAO"/></property>
		<property name="transitionDAO"><ref bean="transitionDAO"/></property>
		<property name="learningDesignDAO"><ref bean="learningDesignDAO"/></property>
	</bean>
	
	<bean id="exportToolContentService" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
		<property name ="transactionManager"><ref bean ="transactionManager"/></property>
		<property name ="target"><ref bean="exportToolContentServiceTarget"/></property>
		
		<!-- TransactionProxyFactoryBean by default just proxies all interfaces implemented by the target object -->
		<!-- AuthoringService is class so needs to be proxied via CGLIB -->
		<!-- Specify "proxyTargetClass" = "true" to generate a CGLIB proxy-->
		<property name="proxyTargetClass"><value>true</value></property>     
		
		<property name="transactionAttributes">
			<props>
				<prop key="save*">PROPAGATION_REQUIRED</prop>
				<prop key="remove*">PROPAGATION_REQUIRED</prop>
				<prop key="export*">PROPAGATION_REQUIRED</prop>
				<prop key="import*">PROPAGATION_REQUIRED</prop>
			</props>
		</property>
	</bean>
	<!--  Access a message service related to a programatically loaded message file. -->
	<!--  Can be used to arbitrarily access any message file that is on the classpath -->
	<!--  as long as you know the file's name and full path.                          -->
	<bean id="loadedMessageSourceService" class="org.lamsfoundation.lams.util.LoadedMessageSourceService" singleton="true">
    </bean>
    	
    <!--  Each message service created by loadedMessageService is a ResourceBundleMessageSource -->
	<bean id="loadedMessageSource" class="org.springframework.context.support.ResourceBundleMessageSource"  singleton="false">
	</bean>
		
	<!-- auditing service -->
	<bean id="auditService" class="org.lamsfoundation.lams.util.audit.AuditService"  singleton="true">
		<property name="messageService"><ref bean="commonMessageService"/></property>
    </bean>

	<!-- Learning Design related beans-->
	
	<bean id="activityDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.ActivityDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	<bean id="learningLibraryDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.LearningLibraryDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	<bean id="learningDesignDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.LearningDesignDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>	
	<bean id="transitionDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.TransitionDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>	
	<bean id="groupingDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.GroupingDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>	
	<bean id="groupDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.GroupDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	<bean id="licenseDAO" class="org.lamsfoundation.lams.learningdesign.dao.hibernate.LicenseDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>	
	
	<!--User management related beans -->
	
	<bean id="userDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.UserDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>

	<bean id="roleDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.RoleDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	
	<bean id="organisationDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.OrganisationDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>

	<bean id="organisationTypeDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.OrganisationTypeDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>

	<bean id="authenticationMethodDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.AuthenticationMethodDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>

	<bean id="userOrganisationDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.UserOrganisationDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>

	<bean id="userOrganisationRoleDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.UserOrganisationRoleDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>	
	
	<bean id="userManagementWorkspaceDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.WorkspaceDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	
	<bean id="workspaceFolderDAO" class="org.lamsfoundation.lams.usermanagement.dao.hibernate.WorkspaceFolderDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>	
	
	<bean id="workspaceFolderContentDAO" class="org.lamsfoundation.lams.workspace.dao.hibernate.WorkspaceFolderContentDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	
	<!--  Theme beans -->
	<bean id="themeDAO" class="org.lamsfoundation.lams.themes.dao.hibernate.CSSThemeDAO">
		<property name="sessionFactory"><ref local="coreSessionFactory"/></property>
	</bean>
	
	<!--  System Session bean -->
	<bean id="SystemSession"
	    class="org.lamsfoundation.lams.web.session.SessionManager"
	    init-method="init"
	    destroy-method="destroy"
		singleton="true">
		<property name="monitorPeriod"><value>60</value></property>
	</bean>
	
	<!-- Cache Manager bean. cacheObjectName should be the same value as hibernate.treecache.objectName -->
	<bean id="cacheManager" class="org.lamsfoundation.lams.cache.CacheManager">
		<property name="cacheObjectName"><value>jboss.cache:service=TreeCache</value></property>
	</bean>
	
	<!--  -->
	
</beans>
