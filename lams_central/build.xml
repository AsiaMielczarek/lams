<?xml version="1.0" encoding="UTF-8"?>

<project name="LAMS Central" basedir="." default="print-usage">
	
	<import file="../lams_build/build_base.xml"/> 

	<!-- Additional properties -->
	<property file="../lams_build/shared.properties"/>
	
	<available file="../${lams_planner}/build.xml" property="planner.available" />
	
	<condition property="isRAMS">
		<equals arg1="${conf.application}" arg2="rams" />
	</condition>

	
	<!-- Below are Tool specifc targets and targets overriding ones from the imported base file. -->
	<target name="_copy-war-resources" depends="_copy-language">
		<!-- Internal target: Adds additional web content to Central -->
		<echo>${ant.project.name}: Copying favicon from conf to assembly</echo>
		<copy todir="${build.war.assembly}">
			<fileset dir="${conf.dir}/favicon/${conf.application}">
				<include name="**/*.ico"/>
			</fileset>
		</copy>
		
		<echo>${ant.project.name}: Copying Flash files from conf to assembly</echo>
		<copy todir="${build.war.assembly}/flashxml">
			<fileset dir="${conf.dir}/flashxml/${conf.application}">
				<include name="**/*.xml"/>
			</fileset>
		</copy>
		
		<echo>Copying Pedagogical Planner files, if available</echo>
		<ant antfile="../${lams_planner}/build.xml" target="_copy-to-central" />
	</target>
	
	
	<target name="_update-logo-for-RAMS" if="isRAMS">
		<!-- Internal target: updates logo in built WAR for RAMS project -->
		<echo>Setting login logo to RAMS</echo>
		<move tofile="${build.lib}/${product}.war/images/css/lams_login.gif"
			  file="${conf.web.dir}/images/ramsthemecss/rams_login.gif" 
		      overwrite="true" verbose="true" />
	</target>
	
	
	<target name="_build-war"
	        depends="_build-webdoclet, _copy-war-resources, _jsp-plaincopy, _jsp-precompile">
		
		<!-- Internal target: Builds WAR without archivisation -->
		<echo>${ant.project.name}: Building exploded WAR</echo>
		<copy todir="${build.lib}/${product}.war">
			<fileset dir="${build.war.assembly}">
				<include name="**"/>
			</fileset>
			<fileset dir="${build.war}">
				<include name="WEB-INF/web.xml"/>
			</fileset>
			<fileset dir="${conf.dir}/war">
				<include name="META-INF/MANIFEST.MF"/>
			</fileset>
		</copy>
		
		<antcall target="_update-logo-for-RAMS" />
	</target>
	
	
	<target name="deploy-war" depends="_build-war, explode-war-delete" description="Deploys WAR.">
		<echo>Removing cached files</echo>
		<delete quiet="true">
			<fileset dir="${jboss.deploy}/tmp"/>
			<fileset dir="${jboss.deploy}/work"/>
		</delete>
				
		<echo>${ant.project.name}: Deploying exploded WAR</echo>
		<copy todir="${jboss.deploy}/${product}.war">
			<fileset dir="${build.lib}/${product}.war" />
		</copy>
		
		<echo>${ant.project.name}: Copying language files</echo>
		<copy todir="${jboss.deploy}/lams-dictionary.jar" overwrite="true">
		   <fileset dir="${build.lib}/language" />
		</copy>
	</target>
	
	
	<target name="build-tag-library" description="Generates Tag Library from Java source using XDoclet.">
		<echo>Building LAMS Tag Library using XDoclet</echo>
		<webdoclet destDir="${conf.webinf.dir}/tlds/lams"
			       mergeDir="${conf.xdoclet.dir}"
			       force="${xdoclet.force}">
			<fileset dir="${src.java.dir}">
				<include name="**/*.java" />
				<exclude name="**/*Skeleton.java" />
			</fileset>
			
			<jsptaglib jspversion="2.0"
					   taglibversion="1.0"
					   shortname="lams"
			 		   displayname="LAMSTags"
					   description="LAMS custom tags"
			 		   filename="lams.tld"
					   validatexml="true"
			/>
		</webdoclet>
	</target>
	
	
	<!-- Not needed. Does not even display warning to avoid confusion -->
	<target name="_build-hbm" />
	
	
	<target name="explode-war" depends="_target-not-available" description="Explodes deployed WAR to folder." />

</project>