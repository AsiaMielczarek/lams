<?xml version="1.0" encoding="UTF-8"?>

<project name="LAMS" default="usage" basedir=".">

	<!-- import properties from the specified file -->
	<property file="shared.properties" />
	<property file="windows.properties" />
	<!--<property file="linux.properties"/>-->


	<target name="init">
		<mkdir dir="${assembly.dir}" />
	</target>

	<target name="usage" description="print usage message">
		<echo>usage: this message</echo>
		<echo>clean: clean the ear assembly directories</echo>
		<echo>
			clean-subprojects: clean sub project build directories
		</echo>
		<echo>build-subprojects: build sub projects</echo>
		<echo>assemble-ear: assemble ear structure</echo>
		<echo>deploy-ear: copy ear to local jboss server</echo>
		<echo>
			copyfiles: copy configuration files to local jboss server
		</echo>
	</target>

	<!-- clean dirs for this script only -->
	<target name="clean" description="cleans assembly">
		<delete includeEmptyDirs="true" dir="${assembly.dir}"
			includes="**/*" />
	</target>

	<!-- clean all projects -->
	<target name="clean-subprojects" description="cleans sub projects" />


	<!-- build sub-projects -->
	<target name="build-subprojects"
		description="builds sub porjects">
		<ant antfile="../${lams_common}/build.xml" target="build-jar"
			inheritAll="false" />
		<ant antfile="../${lams_contentrepository}/build.xml"
			target="build-jar" inheritAll="false" />
		<ant antfile="../${lams_central}/build.xml" target="build-war"
			inheritAll="false" />
		<ant antfile="../${lams_workspace}/build.xml" target="build-war"
			inheritAll="false" />
		<ant antfile="../${lams_authoring}/build.xml"  target="build-war"
			inheritAll="false"/>
		<!--  <ant antfile="../${lams_learning}/build.xml" target="build-war" inheritAll="false"/> -->
		<!--  <ant antfile="../${lams_monitoring}/build.xml"  target="build-war" inheritAll="false"/> -->
		<!--
			<ant antfile="../${lams_admin}/build.xml" target="build-war" inheritAll="false"/>
		-->
	</target>

	<!-- assemble ear -->
	<target name="assemble-ear" depends="init, clean, build-subprojects"
		description="Assemble lasm ear in exploded form">
		<!-- have to copy the libs etc. to a temp location otherwise we end up with all the directories under lib as well-->
		<mkdir dir="${assembly.dir}/temp" />
		<copy todir="${assembly.dir}/temp" failonerror="true"
			flatten="true">
			<fileset dir="${lib.dir}">
				<patternset id="lib.jars">
					<!--  the desired jars are nominated explicitly so -->
					<!--  we don't release a build only one by accident -->
					<include name="aopalliance/*.jar" />
					<include name="cglib/*.jar" />
					<include name="dom4j/*.jar" />
					<include name="ehcache/*.jar" />
					<include name="fckEditor/*.jar" />
					<include name="hibernate/*.jar" />
					<include name="j2ee/*.jar" />
					<include name="jakarta-commons/*.jar" />
					<include name="jakarta-poi/*.jar" />
					<include name="jakarta-taglibs/*.jar" />
					<include name="jboss/*.jar" />
					<include name="jdom/*.jar" />
					<include name="log4j/*.jar" />
					<include name="mysql/*.jar" />
					<include name="odmg/*.jar" />
					<include name="spring/*.jar" />
					<include name="struts/*.jar" />
					<include name="wddx/*.jar" />
				</patternset>
			</fileset>
			<fileset dir="..">
				<include name="${lams.jar}" />
				<include name="${lams_contentrepository.jar}" />
				<include name="${lams_central.war}" />
				<include name="${lams_workspace.jar}"/>
				<include name="${lams_workspace.war}"/>
				<include name="${lams_authoring.jar}"/>
				<include name="${lams_authoring.war}"/>
			<!-- 	<include name="${lams_monitoring.war}"/>
				<include name="lams_learning.war"/>
					<include name="lams_admin.war"/-->

			</fileset>
		</copy>
		<!-- create a temporary ear -->
		<ear destfile="${assembly.temp.ear}" compress="false"
			appxml="${app.xml}">
			<fileset dir="${assembly.dir}/temp" includes="*" />
		</ear>
		<!-- remove temp lib -->
		<delete dir="${assembly.dir}/temp" includeEmptyDirs="true" />
		<!-- explode the ear (Why doesn't the EAR task support exploded format?) -->
		<unjar src="${assembly.temp.ear}" dest="${assembly.lams.ear}" />
		<!-- delete temp.ear -->
		<delete file="${assembly.temp.ear}" />
	</target>


	<!-- ============================================================================== -->
	<!-- Deploy the ear file to the server                                              -->
	<!-- ============================================================================== -->

	<target name="deploy-ear" 
		description="Deploys previously assembled ear to jboss">
		<copy todir="${jboss.deploy.dir}" overwrite="true"
			failonerror="true" verbose="true">
			<fileset dir="${assembly.dir}">
				<include name="${lams.ear}/**/*.*" />
			</fileset>

		</copy>
	</target>

	<!-- ============================================================================== -->
	<!-- Copy the third party jar files and cofiguration files for deployment           -->
	<!-- ============================================================================== -->
	<target name="makeconfdir">
		<delete quiet="true">
			<fileset dir="${lamsconf}" />
		</delete>
		<mkdir dir="${lamsconf}" />
	</target>

	<target name="copyfiles" depends="makeconfdir"
		description="copy lib and config files">
		<copy overwrite="yes" todir="${jboss.server.dir}/conf/">
			<fileset dir="${conf.jboss}/">
				<include name="login-config.xml" />
			</fileset>
		</copy>
		<copy overwrite="yes" todir="${lamsconf}">
			<fileset dir="${conf.auth}/">
				<include name="*.xml" />
				<include name="*.dtd" />
			</fileset>
			<fileset dir="${conf.lams}/">
				<include name="*.xml" />
				<include name="*.dtd" />
			</fileset>
		</copy>
		<copy overwrite="yes" todir="${jboss.deploy.dir}">
			<fileset dir="${conf.jboss}/service">
				<include name="mysql*.xml" />
			</fileset>
		</copy>
	</target>

</project>
